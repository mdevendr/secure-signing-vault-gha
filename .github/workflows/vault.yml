name: Test Vault OIDC Connectivity

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  test-vault-oidc:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Get OIDC Token
        id: oidc
        run: |
          OIDC_RESPONSE=$(curl -s \
            -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=vault")

          OIDC_TOKEN=$(echo "$OIDC_RESPONSE" | jq -r '.value')

          if [ -z "$OIDC_TOKEN" ] || [ "$OIDC_TOKEN" = "null" ]; then
            echo "ERROR: Failed to fetch OIDC token."
            exit 1
          fi

          echo "oidc_token=$OIDC_TOKEN" >> $GITHUB_OUTPUT

      - name: Login to Vault using JWT
        id: vault
        run: |
          jq -n \
            --arg jwt "${{ steps.oidc.outputs.oidc_token }}" \
            --arg role "github-actions" \
            '{jwt: $jwt, role: $role}' > payload.json

          LOGIN_RESPONSE=$(curl -s \
            --header "Content-Type: application/json" \
            --data @payload.json \
            "${{ secrets.VAULT_ADDR }}/v1/auth/jwt/login")

          CLIENT_TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.auth.client_token')

          if [ -z "$CLIENT_TOKEN" ] || [ "$CLIENT_TOKEN" = "null" ]; then
            echo "ERROR: Vault login failed."
            exit 1
          fi

          echo "vault_token=$CLIENT_TOKEN" >> $GITHUB_OUTPUT

      - name: Build Demo Image
        id: build
        run: |
          docker build -t demo-image:latest .
      
          DIGEST=$(docker image inspect demo-image:latest --format='{{index .Id}}' | sed 's/sha256://')
      
          if [ -z "$DIGEST" ]; then
            echo "ERROR: Failed to extract image digest."
            exit 1
          fi
      
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
      
          DIGESTB64=$(echo -n "$DIGEST" | xxd -r -p | base64)
      
          if [ -z "$DIGESTB64" ]; then
            echo "ERROR: Failed to convert digest to base64."
            exit 1
          fi
      
          echo "b64=$DIGESTB64" >> $GITHUB_OUTPUT


      - name: Test Transit Signing
        id: sign
        run: |
          jq -n \
            --arg input "${{ steps.build.outputs.b64 }}" \
            '{input: $input}' > sign.json

          SIGN_RESPONSE=$(curl -s \
            --header "X-Vault-Token: ${{ steps.vault.outputs.vault_token }}" \
            --header "Content-Type: application/json" \
            --data @sign.json \
            "${{ secrets.VAULT_ADDR }}/v1/transit/sign/gha-signing-key")

          SIG=$(echo "$SIGN_RESPONSE" | jq -r '.data.signature')

          if [ -z "$SIG" ] || [ "$SIG" = "null" ]; then
            echo "ERROR: Transit signing failed."
            exit 1
          fi

          echo "Signature successfully produced."
          echo "signature=$SIG" >> $GITHUB_OUTPUT
