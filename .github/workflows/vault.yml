name: Test Vault OIDC Connectivity

on:
  workflow_dispatch:

permissions:
  id-token: write       # REQUIRED for OIDC
  contents: read

jobs:
  test-vault-oidc:
    runs-on: ubuntu-latest

    steps:
      - name: Debug OIDC Token
        id: oidc
        run: |
          TOKEN=$(curl -s \
            -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=vault")
          
          echo "oidc_token=$TOKEN" >> $GITHUB_OUTPUT
          echo "OIDC Token received."

      - name: Login to Vault via JWT
        id: vault
        run: |
          LOGIN_RESPONSE=$(curl -s \
            --request POST \
            --data "{\"jwt\": \"${{ steps.oidc.outputs.oidc_token }}\", \"role\": \"github-actions\"}" \
            ${{ secrets.VAULT_ADDR }}/v1/auth/jwt/login)

          echo "Vault login response:"
          echo "$LOGIN_RESPONSE" | jq .

          CLIENT_TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.auth.client_token')
          
          if [ "$CLIENT_TOKEN" = "null" ]; then
            echo "Vault login FAILED."
            exit 1
          fi

          echo "vault_token=$CLIENT_TOKEN" >> $GITHUB_OUTPUT
          echo "Vault login SUCCESS."

      - name: Test Transit Signing (Optional)
        run: |
          SIGN_RESPONSE=$(curl -s \
            --request POST \
            --header "X-Vault-Token: ${{ steps.vault.outputs.vault_token }}" \
            --data '{"input": "ZmFrZS1kaWdlc3Q="}' \
            ${{ secrets.VAULT_ADDR }}/v1/transit/sign/gha-signing-key)

          echo "Transit sign response:"
          echo "$SIGN_RESPONSE" | jq .
